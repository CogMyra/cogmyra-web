<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CogMyra Admin Metrics</title>
  <style>
    :root{
      --bg:#fafafa; --fg:#111; --muted:#667085; --line:#e2e8f0; --brand:#2563eb;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    main{max-width:1000px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 12px}
    p{color:var(--muted)}
    .controls{
      display:flex; gap:12px; align-items:center; margin:16px 0 24px;
      padding:12px; background:#fff; border:1px solid var(--line); border-radius:10px;
    }
    button{
      border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer;
    }
    button.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
    button:disabled{ opacity:.5; cursor:not-allowed }
    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); border-radius:10px; overflow:hidden }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left }
    th{ background:#f8fafc; font-weight:600 }
    tr:last-child td{ border-bottom:none }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    @media (max-width:800px){ .row{ grid-template-columns:1fr } }
    .note{ font-size:.9rem; color:var(--muted) }
    .error{ color:#b91c1c }
    .pill{ font-size:.85rem; color:var(--muted); }
    .spacer{ height:8px }
  </style>
</head>
<body>
  <main>
    <h1>CogMyra Metrics Dashboard</h1>
    <p class="note">Daily activity and mode usage pulled from <code>/api/metrics/summary</code>. CSV exports are fetched with an admin key and downloaded locally.</p>

    <div class="controls">
      <label class="pill">Window:
        <select id="window">
          <option value="14">Last 14 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="60">Last 60 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </label>
      <button id="btn-refresh" class="primary">Refresh Data</button>
      <div style="flex:1"></div>
      <button id="btn-export-events">Export events CSV</button>
      <button id="btn-export-artifacts">Export artifacts CSV</button>
      <a href="/guide/privacy.html" target="_blank" class="pill">Privacy &amp; Export Notice</a>
    </div>

    <div id="status" class="note"></div>
    <div id="error" class="error"></div>

    <div class="spacer"></div>

    <div class="row">
      <section>
        <h2>Daily Summary (last 14 days)</h2>
        <table id="tbl-daily">
          <thead><tr><th>Date</th><th>DAU</th><th>Total Events</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section>
        <h2>Top Modes (last 30 days)</h2>
        <table id="tbl-modes">
          <thead><tr><th>Mode</th><th>Count</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    // --- Admin key handling ---
    // We avoid hardcoding the key by asking once and storing in localStorage.
    // You can clear/change it anytime via the prompt.
    const KEY_NAME = "cmg_admin_app_key";
    function ensureAdminKey() {
      let k = localStorage.getItem(KEY_NAME);
      if (!k) {
        k = prompt("Enter admin x-app-key for exports:");
        if (!k) throw new Error("Missing admin key");
        localStorage.setItem(KEY_NAME, k);
      }
      return k;
    }
    function clearAdminKey() {
      localStorage.removeItem(KEY_NAME);
      alert("Admin key cleared.");
    }

    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("error");
    const dailyTbody = document.querySelector("#tbl-daily tbody");
    const modesTbody = document.querySelector("#tbl-modes tbody");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setError(msg){ errEl.textContent = msg || ""; }

    async function refresh() {
      setStatus("Loading…");
      setError("");

      try {
        const res = await fetch("/api/metrics/summary", { headers: { "x-app-key": ensureAdminKey() }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderDaily(data.daily_summary || []);
        renderModes(data.top_modes || []);
        setStatus(`Updated • ${new Date(data.generated_at || Date.now()).toLocaleString()}`);
      } catch (e) {
        setError(e.message || String(e));
        setStatus("");
      }
    }

    function renderDaily(rows){
      dailyTbody.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        const d = document.createElement("td");
        d.textContent = r.date;
        const dau = document.createElement("td");
        dau.textContent = r.dau;
        const te = document.createElement("td");
        te.textContent = r.total_events;
        tr.append(d, dau, te);
        dailyTbody.append(tr);
      }
      if (!rows.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3; td.textContent = "No data yet.";
        tr.append(td); dailyTbody.append(tr);
      }
    }

    function renderModes(rows){
      modesTbody.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        const m = document.createElement("td");
        m.textContent = r.mode;
        const c = document.createElement("td");
        c.textContent = r.count;
        tr.append(m, c);
        modesTbody.append(tr);
      }
      if (!rows.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 2; td.textContent = "No data yet.";
        tr.append(td); modesTbody.append(tr);
      }
    }

    async function exportCsv(kind){
      setStatus(`Exporting ${kind}…`);
      setError("");
      const days = document.getElementById("window").value;
      const url = `/api/metrics/export/${kind}.csv?days=${encodeURIComponent(days)}`;

      try {
        const res = await fetch(url, { headers: { "x-app-key": ensureAdminKey() }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const blob = await res.blob();
        const fname = `${kind}_last_${days}d.csv`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setStatus(`Exported ${fname}`);
      } catch (e) {
        setError(e.message || String(e));
        setStatus("");
      }
    }

    document.getElementById("btn-refresh").addEventListener("click", refresh);
    document.getElementById("btn-export-events").addEventListener("click", () => exportCsv("events"));
    document.getElementById("btn-export-artifacts").addEventListener("click", () => exportCsv("artifacts"));

    // Initial load
    refresh();
  </script>
</body>
</html>
