<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CogMyra Admin Metrics</title>
    <style>
      :root {
        --bg: #fafafa;
        --fg: #222;
        --muted: #6b7280;
        --line: #e5e7eb;
      }
      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 40px;
        background: var(--bg);
        color: var(--fg);
      }
      h1 { margin: 0 0 6px; }
      p.lead { margin: 0 0 18px; color: var(--muted); }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
      .card {
        background: #fff; border: 1px solid var(--line); border-radius: 10px;
        padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.03);
      }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { padding: 8px 10px; border-bottom: 1px solid var(--line); text-align: left; }
      th { background: #f8fafc; font-weight: 600; }
      .controls { margin: 10px 0 16px; display: flex; gap: 10px; align-items: center; }
      button {
        padding: 6px 10px; border-radius: 8px; border: 1px solid var(--line);
        background: #fff; cursor: pointer;
      }
      button:disabled { opacity: .6; cursor: not-allowed; }
      #error { color: #b91c1c; font-size: .9rem; }
      .muted { color: var(--muted); font-size: .9rem; }
      footer { margin-top: 28px; color: var(--muted); font-size: .85rem; }
    </style>
  </head>
  <body>
    <h1>CogMyra Metrics Dashboard</h1>
    <p class="lead">Daily activity and mode usage pulled from <code>/api/metrics/summary</code>.</p>

    <div class="controls">
      <button id="refresh">Refresh Data</button>
      <span id="status" class="muted"></span>
      <span id="error"></span>
    </div>

    <div class="row">
      <div class="card">
        <h2 style="margin:0">Daily Summary (last 14 days)</h2>
        <table id="summary">
          <thead>
            <tr>
              <th>Date</th>
              <th>Daily Active Users</th>
              <th>Total Events</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2 style="margin:0">Top Modes (last 30 days)</h2>
        <table id="modes">
          <thead>
            <tr>
              <th>Mode</th>
              <th>Usage Count</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>
      Generated by CogMyra • <span id="generatedAt" class="muted"></span>
    </footer>

    <script>
      const refreshBtn = document.getElementById("refresh");
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const genAtEl = document.getElementById("generatedAt");
      const summaryBody = document.querySelector("#summary tbody");
      const modesBody = document.querySelector("#modes tbody");

      async function fetchMetrics() {
        refreshBtn.disabled = true;
        errorEl.textContent = "";
        statusEl.textContent = "Loading…";
        summaryBody.innerHTML = "<tr><td colspan='3'>Loading…</td></tr>";
        modesBody.innerHTML = "<tr><td colspan='2'>Loading…</td></tr>";

        try {
          const res = await fetch("/api/metrics/summary");
          if (!res.ok) throw new Error("Failed to fetch metrics (" + res.status + ")");
          const data = await res.json();

          // Populate summary table
          summaryBody.innerHTML = "";
          (data.daily_summary || []).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.date}</td>
              <td>${row.dau}</td>
              <td>${row.total_events}</td>
            `;
            summaryBody.appendChild(tr);
          });

          // Populate modes table
          modesBody.innerHTML = "";
          (data.top_modes || []).forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.mode ?? "—"}</td>
              <td>${row.count}</td>
            `;
            modesBody.appendChild(tr);
          });

          genAtEl.textContent = data.generated_at || "";
          statusEl.textContent = "Updated";
          setTimeout(() => (statusEl.textContent = ""), 1500);
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Error: " + err.message;
          statusEl.textContent = "";
        } finally {
          refreshBtn.disabled = false;
        }
      }

      refreshBtn.addEventListener("click", fetchMetrics);
      fetchMetrics();
    </script>
  </body>
</html>
